# Catálogo (Cloudflare Pages + D1)\nAPI e site estático para um **catálogo de produtos** com **compra** (baixa de estoque) – tudo hospedado no **Cloudflare Pages**, sem precisar de configuração de CORS quando o **frontend vive no mesmo domínio** da API. **URL:** https://catalogo-products.pages.dev • **Swagger:** https://catalogo-products.pages.dev/docs/\n\n## Visão geral\nFrontend (HTML/CSS/JS) e API (Pages Functions) no mesmo projeto; Banco: Cloudflare D1 (SQLite gerenciado); Objetivo: alunos consumirem a API usando apenas HTML + CSS + JS (sem framework, sem CORS); Catálogo populado com 500 produtos; compras baixam estoque. ⚠️ Para evitar CORS, hospede o front no MESMO domínio do Pages.\n\n## Como consumir (sem CORS)\nUse paths relativos no mesmo domínio: `fetch('/api/products?page=1&pageSize=10')` • `fetch('/api/orders',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({buyer:{name:'Cliente',email:'c@demo.com'},items:[{productId:'PROD-0001',qty:1}]})})`\n\n## Endpoints\n**GET /api/products** → lista paginada. Params: `page` (default 1), `pageSize` (default 10). Ex.: `/api/products?page=1&pageSize=10`. Resumo de resposta: `{ meta:{ total, page, pageSize }, products:[{ id,title,slug,category,brand,description, price:{currency:'BRL',original,discount_percent,final}, stock:{quantity,sku,warehouse}, rating:{average,count}, created_at,updated_at }] }`.\n**POST /api/orders** → cria pedido e baixa estoque. Body: `{ "buyer": { "name":"Cliente", "email":"c@demo.com" }, "items":[{ "productId":"PROD-0001", "qty":1 }] }`. Resumo de resposta: `{ order:{ id, created_at, buyer:{name,email}, total, items:[{productId,qty,unit_price,line_total}] } }`. Erros: `400` (payload inválido), `409` (estoque insuficiente).\n\n## Exemplos\n**fetch (JS):** `const r=await fetch('/api/products?page=1&pageSize=10'); const data=await r.json();` • `await fetch('/api/orders',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({buyer:{name:'Cliente',email:'c@demo.com'},items:[{productId:'PROD-0001',qty:1}]})});`\n**curl:** `curl "https://catalogo-products.pages.dev/api/products?page=1&pageSize=10"` • `curl -X POST "https://catalogo-products.pages.dev/api/orders" -H "Content-Type: application/json" -d '{"buyer":{"name":"Cliente","email":"c@demo.com"},"items":[{"productId":"PROD-0001","qty":1}]}'`\n\n## Formatos\n**Produto:** `{ id,title,slug,category,brand,description, price:{currency,original,discount_percent,final}, stock:{quantity,sku,warehouse}, rating:{average,count}, created_at,updated_at }` • **Pedido:** `{ id,created_at,buyer:{name,email},total,items:[{productId,qty,unit_price,line_total}] }`.\n\n## Estrutura do projeto\n`/index.html` (exemplo front) • `/docs/index.html` (Swagger UI) • `/docs/openapi.yaml` (OpenAPI) • `/functions/api/products.js` (GET) • `/functions/api/orders.js` (POST) • (opcional) `/functions/index.js` para redirecionar `/`.\n\n## Banco (Cloudflare D1)\nTabelas: `products(id PK, title, slug, category, brand, description, price_original, price_discount_percent, price_final, sku, stock_quantity, warehouse, rating_average, rating_count, created_at, updated_at)` • `orders(id PK, created_at, buyer_name, buyer_email, total)` • `order_items(id PK, order_id FK, product_id FK, qty, unit_price, line_total)`.\n**Binding Pages → Functions → Bindings:** D1 database **Name:** `DB` → **Database:** `catalogo_db`.\n\n## Publicar mudanças\nRepo conectado ao Cloudflare Pages com deploy automático: push no `main` → novo deploy. Verifique em Deployments → View details → **Functions**. Para redeploy manual: `git commit --allow-empty -m "redeploy" && git push`.\n\n## Dicas & troubleshooting\nSem CORS: front e API no mesmo domínio (use `fetch('/api/...')`). **Erro 1101**: veja logs em Deployments → View details → Functions → View logs (SQL inválido, etc.). **Sem dados?** Banco já vem com 500 itens; se zerou, repopule manualmente no D1 ou reative temporariamente um seed. **Reset D1:** `DELETE FROM order_items; DELETE FROM orders; DELETE FROM products;` (repopule depois, se necessário).\n\n## Licença\nUso educacional. Ajuste conforme sua necessidade.\n\n**Nota p/ instrutor:** para cada aluno ter sua própria API sem CORS, peça para cada um *forkar* o repo e conectar ao Cloudflare Pages com seu próprio D1; cada fork terá URL/banco próprios.
